<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed A - Urban Engine</title>
    <style>
        /* ==========================================================================
        Urban Engine – Font Size Scale Reference (px-based)
        기준: Web(Desktop) px → 반응형 축소 매핑
        --------------------------------------------------------------------------
        Web px | Tablet px | Mobile px | Small Mobile px
        --------------------------------------------------------------------------
        44 | 38 | 32 | 26
        38 | 34 | 28 | 24
        28 | 26 | 24 | 20
        24 | 22 | 18 | 16
        22 | 20 | 16 | 14
        20 | 18 | 14 | 13
        18 | 16 | 14 | 13
        16 | 16 | 15 | 14
        15 | 15 | 14 | 13
        14 | 14 | 13 | 13
        13 | 13 | 13 | 13

        Usage rule:
        - Web px 값을 기준으로 선택
        - Tablet / Mobile / Small Mobile은 위 매핑을 그대로 적용
        - clamp(), media query, rem 변환의 기준 테이블로 사용
        ========================================================================== */

        @font-face {
            font-family: 'esamanruLight';
            src: url('Source/Fonts/esamanru Light.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'esamanruMedium';
            src: url('Source/Fonts/esamanru Medium.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --violet: #6f41b0;
            --gray: #808080;
            --light-gray: #b3b3b3;
            --black: #111111;
            --white: #f9f9f9;
            --orange: #f7931e;
            --bg: #f6f7f9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'esamanruLight', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--black);
        }

        .page {
            max-width: 1080px;
            margin: 0 auto;
            padding: 50px 50px 80px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
        }

        .logo {
            font-family: 'esamanruMedium', sans-serif;
            font-size: 24px;
            color: var(--black);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logo:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .tab-group {
            display: flex;
            gap: 15px;
            margin: 120px 0 50px;
        }

        .tab {
            flex: 1;
            max-width: 150px;
            padding: 8px 24px;
            border-radius: 16px;
            font-size: 16px;
            font-family: 'esamanruMedium', sans-serif;
            background-color: var(--gray);
            color: var(--white);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tab:active {
            transform: translateY(0);
        }

        .tab.active {
            background: linear-gradient(135deg, #8B5CF6 0%, #6f41b0 100%);
            box-shadow: 0 4px 12px rgba(111, 65, 176, 0.3);
        }

        .tab.active:hover {
            box-shadow: 0 6px 16px rgba(111, 65, 176, 0.4);
        }

        .section {
            padding: 6px 2px;
            margin-bottom: px;
        }

        .section-title {
            font-family: 'esamanruMedium', sans-serif;
            font-size: 28px;
            margin-top: 200px;
            margin-bottom: 14px;
        }

        .section-subtitle {
            color: var(--gray);
            font-size: 24px;
            margin-bottom: 12px;
        }

        .headline {
            font-family: 'esamanruMedium', sans-serif;
            font-size: 44px;
            margin-bottom: 22px;
        }

        .headline span {
            background: linear-gradient(135deg, #8B5CF6 0%, #6f41b0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .bullet-list {
            list-style: none;
            display: grid;
            gap: 4px;
            color: var(--gray);
            font-size: 22px;
        }

        .bullet-list li {
            transition: all 0.3s ease;
            padding: 4px 0;
            cursor: default;
        }

        .bullet-list li:hover {
            transform: translateX(5px);
            color: var(--black);
        }

        .bullet-list li::before {
            content: "✓";
            color: var(--violet);
            margin-right: 8px;
            font-family: 'esamanruMedium', sans-serif;
            transition: all 0.3s ease;
        }

        .bullet-list li:hover::before {
            transform: scale(1.2);
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
            margin-top: 16px;
        }

        .pattern-card {
            background: var(--white);
            border-radius: 40px;
            padding: 22px;
            border: 1px solid rgba(17, 17, 17, 0.06);
            text-align: center;
            min-height: 210px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pattern-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
        }

        .pattern-card:active {
            transform: translateY(-2px);
        }

        .pattern-card span {
            font-size: 28px;
            color: var(--gray);
        }

        .pattern-card strong {
            font-size: 38px;
            font-family: 'esamanruMedium', sans-serif;
            color: var(--violet);
        }

        .pattern-card strong.violet {
            color: var(--violet);
        }

        .pattern-card strong.gray {
            color: var(--gray);
        }

        .cta-chip {
            margin-top: 40px;
            width: 100%;
            background-color: #a5a5a5;
            color: var(--white);
            border-radius: 18px;
            padding: 10px 16px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .cta-chip:hover {
            background-color: #959595;
            transform: scale(1.02);
        }

        .cta-chip:active {
            transform: scale(0.98);
        }

        .ranking-title {
            font-family: 'esamanruMedium', sans-serif;
            font-size: 28px;
            margin-top: 200px;
            margin-bottom: 30px;
        }

        .ranking-item {
            display: grid;
            grid-template-columns: auto 1fr 300px;
            gap: 24px;
            align-items: start;
            margin-top: 0px;
        }

        .ranking-content {
            display: flex;
            flex-direction: column;
        }

        .ranking-item>.map-placeholder {
            align-self: stretch;
            height: auto;
            margin-top: 84px;
            aspect-ratio: 16 / 10;
            overflow: hidden;
            position: relative;
        }

        .ranking-item>.map-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border-radius: 18px;
        }

        .gps-marker {
            position: absolute;
            width: 28px !important;
            height: 28px !important;
            max-width: 28px;
            max-height: 28px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }

        .ranking-card {
            background-color: var(--white);
            border-radius: 30px;
            padding: 30px 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(17, 17, 17, 0.06);
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .ranking-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .ranking-label {
            font-family: 'esamanruMedium', sans-serif;
            color: var(--black);
            font-size: 24px;
            white-space: nowrap;

        }

        .ranking-header {
            margin-bottom: 14px;
        }

        .ranking-name {
            font-family: 'esamanruMedium', sans-serif;
            color: var(--violet);
            font-size: 24px;
            margin-bottom: 0px;
            transition: all 0.3s ease;
        }

        .ranking-desc {
            color: var(--gray);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 4px;
        }

        .metrics {
            display: flex;
            gap: 14px;
            margin: 24px 0 20px;
        }

        .metric-chip {
            background-color: #f4f5f7;
            color: var(--gray);
            border-radius: 28px;
            padding: 16px 22px;
            font-size: 16px;
            flex: 1;
            min-height: 150px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'esamanruMedium', sans-serif;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .metric-chip:hover {
            background-color: #eceef2;
            transform: scale(1.03);
        }

        .metric-chip strong {
            display: block;
            margin-top: 6px;
            font-family: 'esamanruMedium', sans-serif;
            color: var(--gray);
            font-size: 22px;
            transition: all 0.3s ease;
        }

        .metric-chip.orange {
            transition: all 0.3s ease;
        }

        .metric-chip.orange:hover {
            background: linear-gradient(135deg, rgba(247, 147, 30, 0.1) 0%, rgba(247, 147, 30, 0.05) 100%);
        }

        .metric-chip.orange strong {
            color: var(--orange);
        }

        .metric-chip.violet {
            transition: all 0.3s ease;
        }

        .metric-chip.violet:hover {
            background: linear-gradient(135deg, rgba(111, 65, 176, 0.1) 0%, rgba(111, 65, 176, 0.05) 100%);
        }

        .metric-chip.violet strong {
            color: var(--violet);
        }


        .cta-button {
            display: block;
            margin-top: 5px;
            background: linear-gradient(135deg, #8B5CF6 0%, #6f41b0 100%);
            color: var(--white);
            border-radius: 22px;
            padding: 12px 22px;
            font-size: 16px;
            font-family: 'esamanruMedium', sans-serif;
            text-decoration: none;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(111, 65, 176, 0.3);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(111, 65, 176, 0.4);
        }

        .cta-button:active {
            transform: translateY(0);
        }

        .map-placeholder {
            width: 100%;
            border-radius: 18px;
            background: #eef1f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light-gray);
            font-size: 12px;
        }

        .secondary-section {
            margin-bottom: 24px;
        }

        .secondary-header {
            font-family: 'esamanruMedium', sans-serif;
            font-size: 28px;
            margin-top: 160px;
            margin-bottom: 14px;
        }

        .secondary-sub {
            color: var(--light-gray);
            font-size: 24px;
            margin-bottom: 30px;
        }

        .bottom-banner {
            margin-top: 100px;
            background: linear-gradient(135deg, #8B5CF6 0%, #6f41b0 100%);
            color: var(--white);
            font-size: 24px;
            border-radius: 25px;
            padding: 0px 20px;
            text-align: center;
            font-family: 'esamanruMedium', sans-serif;
            line-height: 1.5;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 24px rgba(111, 65, 176, 0.3);
            transition: all 0.3s ease;
        }

        .bottom-banner:hover {
            box-shadow: 0 12px 32px rgba(111, 65, 176, 0.4);
            transform: translateY(-2px);
        }

        /* 태블릿 */
        @media (max-width: 960px) {
            .page {
                padding: 40px 30px 70px;
            }

            .logo {
                font-size: 22px;
            }

            .section-title,
            .ranking-title,
            .secondary-header {
                font-size: 26px;
                margin-top: 150px;
            }

            .section-subtitle,
            .secondary-sub {
                font-size: 22px;
            }

            .headline {
                font-size: 38px;
            }

            .bullet-list {
                font-size: 20px;
            }

            .pattern-card {
                min-height: 180px;
            }

            .pattern-card span {
                font-size: 24px;
            }

            .pattern-card strong {
                font-size: 34px;
            }

            .ranking-item {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .ranking-item>.map-placeholder {
                margin-top: 20px;
                height: auto;
            }
        }

        /* 모바일 */
        @media (max-width: 768px) {
            .page {
                padding: 30px 20px 60px;
            }

            .logo {
                font-size: 20px;
            }

            .tab-group {
                gap: 10px;
                margin: 80px 0 40px;
            }

            .tab {
                padding: 10px 16px;
                font-size: 14px;
                border-radius: 12px;
                max-width: none;
            }

            .section-title,
            .ranking-title,
            .secondary-header {
                font-size: 24px;
                margin-top: 100px;
                margin-bottom: 12px;
            }

            .section-subtitle,
            .secondary-sub {
                font-size: 18px;
                margin-bottom: 10px;
            }

            .headline {
                font-size: 32px;
                margin-bottom: 18px;
            }

            .bullet-list {
                font-size: 16px;
                gap: 6px;
            }

            .pattern-grid {
                grid-template-columns: 1fr;
                gap: 14px;
                margin-top: 14px;
            }

            .pattern-card {
                border-radius: 28px;
                padding: 20px;
                min-height: 140px;
                gap: 14px;
            }

            .pattern-card span {
                font-size: 18px;
            }

            .pattern-card strong {
                font-size: 28px;
            }

            .cta-chip {
                margin-top: 30px;
                font-size: 14px;
                padding: 12px 14px;
                border-radius: 14px;
            }

            .ranking-item {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .ranking-card {
                border-radius: 24px;
                padding: 24px 20px;
                margin-bottom: 20px;
            }

            .ranking-label {
                font-size: 20px;
            }

            .ranking-name {
                font-size: 20px;
            }

            .ranking-desc {
                font-size: 14px;
                line-height: 1.6;
            }

            .metrics {
                flex-direction: column;
                gap: 10px;
                margin: 18px 0 16px;
            }

            .metric-chip {
                padding: 14px 18px;
                font-size: 14px;
                min-height: auto;
                border-radius: 18px;
            }

            .metric-chip strong {
                margin-top: 4px;
                font-size: 18px;
            }

            .cta-button {
                padding: 14px 20px;
                font-size: 15px;
                border-radius: 18px;
            }

            .ranking-item>.map-placeholder {
                margin-top: 0;
                height: auto;
            }

            .bottom-banner {
                margin-top: 80px;
                font-size: 18px;
                border-radius: 20px;
                padding: 30px 20px;
                min-height: 160px;
            }
        }

        /* 작은 모바일 */
        @media (max-width: 480px) {
            .page {
                padding: 20px 16px 50px;
            }

            .logo {
                font-size: 18px;
            }

            .tab-group {
                gap: 8px;
                margin: 60px 0 30px;
            }

            .tab {
                padding: 8px 12px;
                font-size: 13px;
                border-radius: 10px;
            }

            .section-title,
            .ranking-title,
            .secondary-header {
                font-size: 20px;
                margin-top: 80px;
                margin-bottom: 10px;
            }

            .section-subtitle,
            .secondary-sub {
                font-size: 16px;
                margin-bottom: 8px;
            }

            .headline {
                font-size: 26px;
                margin-bottom: 14px;
            }

            .bullet-list {
                font-size: 14px;
                gap: 4px;
            }

            .pattern-grid {
                gap: 12px;
                margin-top: 12px;
            }

            .pattern-card {
                border-radius: 20px;
                padding: 16px;
                min-height: 120px;
                gap: 10px;
            }

            .pattern-card span {
                font-size: 16px;
            }

            .pattern-card strong {
                font-size: 24px;
            }

            .cta-chip {
                margin-top: 24px;
                font-size: 13px;
                padding: 10px 12px;
                border-radius: 12px;
            }

            .ranking-card {
                border-radius: 20px;
                padding: 20px 16px;
                margin-bottom: 16px;
            }

            .ranking-label {
                font-size: 18px;
            }

            .ranking-name {
                font-size: 18px;
            }

            .ranking-desc {
                font-size: 13px;
                line-height: 1.6;
            }

            .metrics {
                gap: 8px;
                margin: 14px 0 14px;
            }

            .metric-chip {
                padding: 12px 16px;
                font-size: 13px;
                border-radius: 16px;
            }

            .metric-chip strong {
                margin-top: 3px;
                font-size: 16px;
            }

            .cta-button {
                padding: 12px 18px;
                font-size: 14px;
                border-radius: 16px;
            }

            .ranking-item>.map-placeholder {
                height: auto;
                border-radius: 14px;
            }

            .map-placeholder {
                border-radius: 14px;
            }

            .bottom-banner {
                margin-top: 60px;
                font-size: 16px;
                border-radius: 18px;
                padding: 25px 16px;
                min-height: 140px;
                line-height: 1.6;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <header>
            <div class="logo">Urban Engine</div>
        </header>

        <div class="tab-group">
            <div class="tab active">매매</div>
            <div class="tab">전세</div>
            <div class="tab">월세</div>
        </div>

        <section class="section">
            <div class="section-subtitle">당신의 주거 선택 선호도는?</div>
            <div class="headline" id="personaHeadline">역 가까운 게 우선</div>
            <ul class="bullet-list" id="personaBulletList">
                <li>출퇴근이랑 이동 시간 줄이는 게 중요함</li>
                <li>집은 좀 커야 할 것 같은데, 고민중</li>
            </ul>
        </section>

        <section class="section">
            <div class="section-title">당신의 주거 선택 패턴은?</div>
            <div class="pattern-grid" id="personaPatternGrid">
                <div class="pattern-card">
                    <span>지하철역 거리</span>
                    <strong class="violet">가까움</strong>
                </div>
                <div class="pattern-card">
                    <span>집값</span>
                    <strong class="gray">비싸도 OK</strong>
                </div>
                <div class="pattern-card">
                    <span>집 크기</span>
                    <strong class="violet">커야함</strong>
                </div>
                <div class="pattern-card">
                    <span>공원과의 거리</span>
                    <strong class="gray">상관 없음</strong>
                </div>
            </div>
            <div class="cta-chip">더 많은 기준을 보고싶다면?( ※ 현재 서비스 준비중이에요! 조금만 기다려주세요. )</div>
        </section>

        <section class="section">
            <!-- 임시로 추천하는 지역 워딩을 변경 (기존 : 서울에서 추천하는 지역 TOP3), 추후 수정 필요 -->
            <div class="ranking-title">선호 기반 추천 지역 TOP3</div>
            <div id="top3DistrictList">
                <div class="ranking-card">
                    <div class="ranking-item">
                        <span class="ranking-label">TOP 1</span>
                        <div>
                            <div class="ranking-header">
                                <span class="ranking-name">11215710_010</span>
                            </div>
                            <div class="ranking-desc">추천 구역 ID</div>
                            <div class="metrics">
                                <div class="metric-chip violet">지하철역 접근성<strong>최고</strong></div>
                                <div class="metric-chip">주민 노후도<strong>적정</strong></div>
                                <div class="metric-chip orange">주택 가격<strong>다소 비쌈</strong></div>
                            </div>
                            <a href="#" class="cta-button">영상으로 살펴보기</a>
                        </div>
                        <div class="map-placeholder">MAP PREVIEW</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="secondary-section">
            <div class="secondary-header">지역 이동이 가능하시다면..?</div>
            <div class="secondary-sub">다음 지역도 검토해보세요! ( ※ 현재 서비스 준비중이에요! 조금만 기다려주세요. )</div>
            <div id="secondaryDistrictList">
                <div class="ranking-card">
                    <div class="ranking-item">
                        <span class="ranking-label">근거리</span>
                        <div>
                            <div class="ranking-header">
                                <span class="ranking-name">11215710_021</span>
                            </div>
                            <div class="ranking-desc">추천 구역 ID</div>
                            <div class="metrics">
                                <div class="metric-chip violet">지하철역 접근성<strong>최고</strong></div>
                                <div class="metric-chip">주민 노후도<strong>적정</strong></div>
                                <div class="metric-chip orange">주택 가격<strong>다소 비쌈</strong></div>
                            </div>
                            <a href="#" class="cta-button">영상으로 살펴보기</a>
                        </div>
                        <div class="map-placeholder">MAP PREVIEW</div>
                    </div>
                </div>
            </div>
        </section>

        <div class="bottom-banner">
            궁금한 지역은 영상으로 살펴보기를 눌러보세요!<br>
            선호에 맞는 맞춤형 피드를 보여드려요.
        </div>
    </div>

    <script>
        // URL 파라미터에서 personaId, trs_type, house_type 가져오기
        function getPersonaIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('personaId') || 'P01'; // 디폴트값: P01
        }

        function getTrsTypeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('trs_type') || '매매'; // 디폴트값: 매매
        }

        function getHouseTypeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('house_type') || ''; // 디폴트값: 빈 문자열
        }

        // 탭 하이라이트 업데이트
        function updateTabHighlight(trsType) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.trim() === trsType) {
                    tab.classList.add('active');
                }
            });
        }

        // house_type을 섹션 subtitle에 추가
        function updateSectionSubtitle(houseType) {
            const subtitle = document.querySelector('.section-subtitle');
            if (subtitle && houseType) {
                subtitle.textContent = `당신의 주거 선택 선호도는? | ${houseType}`;
            }
        }

        // 전역 변수: 페르소나의 상위 4개 preference keys 저장
        let personaTopPreferences = [];
        let prefCardDataCache = null;
        let districtScoreCache = null;
        let markerPositionCache = null;

        // 점수 범위에 따른 텍스트 및 색상 매핑
        const scoreRanges = [
            { min: 0.85, max: 1.00, text: '아주 좋음', color: 'violet' },
            { min: 0.65, max: 0.85, text: '좋음', color: 'violet' },
            { min: 0.35, max: 0.65, text: '보통', color: '' },
            { min: 0.15, max: 0.35, text: '다소 나쁨', color: 'orange' },
            { min: 0.00, max: 0.15, text: '나쁨', color: 'orange' }
        ];

        function getScoreLabel(score) {
            if (score === null || score === undefined) return { text: '데이터 없음', color: '' };

            for (const range of scoreRanges) {
                if (score >= range.min && score < range.max) {
                    return { text: range.text, color: range.color };
                }
                // 마지막 범위 (1.00 포함)
                if (range.max === 1.00 && score === 1.00) {
                    return { text: range.text, color: range.color };
                }
            }
            return { text: '보통', color: '' };
        }

        // A_district_score.json 로드
        async function loadDistrictScores() {
            if (!districtScoreCache) {
                try {
                    const response = await fetch('Data/L2.A/A_district_score.json');
                    if (!response.ok) {
                        throw new Error('Failed to load district scores');
                    }
                    districtScoreCache = await response.json();
                    console.log('District scores loaded:', districtScoreCache.length, 'entries');
                } catch (error) {
                    console.error('Error loading district scores:', error);
                    districtScoreCache = [];
                }
            }
            return districtScoreCache;
        }

        // district_marker_positions.json 로드
        async function loadMarkerPositions() {
            if (!markerPositionCache) {
                try {
                    const response = await fetch('Data/L2.A/district_marker_positions.json');
                    if (!response.ok) {
                        throw new Error('Failed to load marker positions');
                    }
                    markerPositionCache = await response.json();
                    console.log('Marker positions loaded:', markerPositionCache.length, 'entries');
                } catch (error) {
                    console.error('Error loading marker positions:', error);
                    markerPositionCache = [];
                }
            }
            return markerPositionCache;
        }

        // 특정 dist_id에 대한 마커 위치 가져오기
        function getMarkerPosition(distId) {
            if (!markerPositionCache) return null;
            return markerPositionCache.find(item => item.dist_id === distId);
        }

        // 특정 persona_id와 dist_id에 대한 점수 가져오기
        function getDistrictScore(personaId, distId) {
            if (!districtScoreCache) return null;
            return districtScoreCache.find(item =>
                item.persona_id === personaId && item.dist_id === distId
            );
        }

        // 상위 3개 preference 선택 (점수 기반, price_level이 4등이면 3번째로)
        function selectTop3Preferences(scoreData, top4PreferenceKeys) {
            const allScores = [];

            // top 4 preference keys 중에서 점수가 있는 항목들을 수집
            for (const prefKey of top4PreferenceKeys) {
                const score = scoreData[prefKey];
                if (score !== null && score !== undefined) {
                    allScores.push({ key: prefKey, score: score });
                }
            }

            // 점수 내림차순 정렬
            allScores.sort((a, b) => b.score - a.score);

            // price_level의 순위 확인
            const priceLevelIndex = allScores.findIndex(item => item.key === 'price_level');

            // price_level이 없으면 상위 3개 반환
            if (priceLevelIndex === -1) {
                return allScores.slice(0, 3);
            }

            // price_level이 1~3등(인덱스 0~2)이면 상위 3개 그대로 반환
            if (priceLevelIndex < 3) {
                return allScores.slice(0, 3);
            }

            // price_level이 4등(인덱스 3)이면 1등, 2등, price_level 반환
            if (priceLevelIndex === 3) {
                return [allScores[0], allScores[1], allScores[3]];
            }

            // 그 외 경우 상위 3개 반환
            return allScores.slice(0, 3);
        }

        function parseCsv(text) {
            const lines = text.trim().split(/\r?\n/);
            const headers = lines.shift().split(',').map(header => header.replace(/^\uFEFF/, '').trim());

            return lines.map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;

                // 따옴표로 감싼 필드를 올바르게 처리
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim()); // 마지막 값 추가

                // 헤더와 값을 매핑
                return headers.reduce((acc, header, index) => {
                    acc[header] = values[index] ? values[index].replace(/^"|"$/g, '').trim() : '';
                    return acc;
                }, {});
            });
        }

        async function loadPersonaPreferenceCards(personaId) {
            try {
                const [cardResponse, csvResponse] = await Promise.all([
                    fetch('Source/Feed_A_Persona_Pref_Card.json'),
                    fetch('Source/Persona_1.csv')
                ]);

                if (!cardResponse.ok || !csvResponse.ok) {
                    throw new Error('Failed to load preference data');
                }

                const prefCardData = await cardResponse.json();
                prefCardDataCache = prefCardData; // 캐시에 저장

                const csvText = await csvResponse.text();
                const rows = parseCsv(csvText)
                    .filter(row => row.persona_id === personaId)
                    .filter(row => prefCardData[row.preference_key]);

                const sortedRows = rows
                    .map(row => ({
                        ...row,
                        priority: Number.isNaN(parseInt(row.priority, 10)) ? 0 : parseInt(row.priority, 10)
                    }))
                    .sort((a, b) => b.priority - a.priority);

                const topRows = sortedRows.slice(0, 4);

                // 상위 4개 preference keys 저장
                personaTopPreferences = topRows.map(row => row.preference_key);
                console.log('Top 4 preference keys:', personaTopPreferences);

                const patternGrid = document.getElementById('personaPatternGrid');
                if (!patternGrid || topRows.length === 0) {
                    return;
                }

                patternGrid.innerHTML = '';
                topRows.forEach(row => {
                    const cardConfig = prefCardData[row.preference_key];
                    const card = document.createElement('div');
                    card.className = 'pattern-card';

                    const label = document.createElement('span');
                    label.textContent = cardConfig.label;

                    const value = document.createElement('strong');
                    // direction_map의 값이 객체인 경우 .text 속성을 가져옴
                    const directionData = cardConfig.direction_map[row.direction];
                    if (typeof directionData === 'object' && directionData !== null) {
                        value.textContent = directionData.text || row.direction;
                    } else {
                        value.textContent = directionData || row.direction;
                    }

                    // tone 기반 색상 설정
                    const toneToColor = prefCardData.ui_theme?.tone_to_color || { positive: 'violet', neutral: 'gray' };
                    const tone = directionData?.ui?.tone;

                    if (tone && toneToColor[tone]) {
                        const cssClass = toneToColor[tone];
                        if (cssClass === 'violet') {
                            value.className = 'violet';
                        } else if (cssClass === 'gray') {
                            value.className = 'gray';
                        } else {
                            value.style.color = cssClass;
                        }
                    } else {
                        value.className = row.direction === '상관없음' ? 'gray' : 'violet';
                    }

                    card.appendChild(label);
                    card.appendChild(value);
                    patternGrid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading preference cards:', error);
            }
        }

        async function createDistrictCard({ label, distId, personaId }) {
            const card = document.createElement('div');
            card.className = 'ranking-card';

            // dist_id에서 행정동 코드 추출 (언더스코어 앞부분)
            const admCode = distId.split('_')[0];
            const mapImagePath = `Data/L2.A/A_KeyMap/${admCode}_map.png`;

            // CSV 데이터 로드하여 구역 이름과 설명 가져오기
            let distName = distId;
            let distDesc = '추천 구역 ID';

            // await를 사용하여 구역 정보를 먼저 가져옴
            const distInfo = await getDistrictInfo(distId);
            if (distInfo) {
                distName = distInfo.dist_nm || distId;
                distDesc = distInfo.dist_desc || '추천 구역 ID';
                console.log('Using district info:', { distName, distDesc });
            } else {
                console.warn('No district info found for:', distId);
            }

            // 마커 위치 데이터 로드
            await loadMarkerPositions();
            const markerPos = getMarkerPosition(distId);
            let markerHtml = '';

            if (markerPos) {
                const leftPct = markerPos.m_left_pct;
                const topPct = markerPos.m_top_pct;
                markerHtml = `<img src="Source/gps_marker.svg" class="gps-marker" style="left: ${leftPct}%; top: ${topPct}%;" alt="Location Marker">`;
                console.log('Marker position for', distId, ':', leftPct, topPct);
            } else {
                console.warn('No marker position found for:', distId);
            }

            // metric-chip 동적 생성
            let metricsHtml = '';

            if (personaTopPreferences.length > 0 && prefCardDataCache) {
                // 구역 점수 데이터 가져오기
                await loadDistrictScores();
                const scoreData = getDistrictScore(personaId, distId);

                if (scoreData) {
                    // 상위 3개 preference 선택
                    const top3 = selectTop3Preferences(scoreData, personaTopPreferences);
                    console.log('Top 3 preferences for', distId, ':', top3);

                    metricsHtml = top3.map(item => {
                        const prefConfig = prefCardDataCache[item.key];
                        const scoreLabel = getScoreLabel(item.score);
                        const colorClass = scoreLabel.color || '';

                        return `<div class="metric-chip ${colorClass}">${prefConfig.label}<strong>${scoreLabel.text}</strong></div>`;
                    }).join('');
                } else {
                    // 데이터가 없을 경우 기본 3개 표시
                    console.warn('No score data for:', personaId, distId);
                    metricsHtml = personaTopPreferences.slice(0, 3).map(key => {
                        const prefConfig = prefCardDataCache[key];
                        return `<div class="metric-chip">${prefConfig.label}<strong>데이터 없음</strong></div>`;
                    }).join('');
                }
            } else {
                // fallback: 기본 metric-chip
                metricsHtml = `
                    <div class="metric-chip violet">지하철역 접근성<strong>최고</strong></div>
                    <div class="metric-chip">주민 노후도<strong>적정</strong></div>
                    <div class="metric-chip orange">주택 가격<strong>다소 비쌈</strong></div>
                `;
            }

            card.innerHTML = `
                <div class="ranking-item">
                    <span class="ranking-label">${label}</span>
                    <div>
                        <div class="ranking-header">
                            <span class="ranking-name">${distName}</span>
                        </div>
                        <div class="ranking-desc">${distDesc}</div>
                        <div class="metrics">
                            ${metricsHtml}
                        </div>
                        <a href="#" class="cta-button">영상으로 살펴보기</a>
                    </div>
                    <div class="map-placeholder">
                        <img src="${mapImagePath}" alt="Map">
                        ${markerHtml}
                    </div>
                </div>
            `;

            return card;
        }

        // CSV 캐시 (시군구별로 저장)
        let districtCsvCache = {};

        // CSV 파일에서 구역 정보 가져오기
        async function getDistrictInfo(distId) {
            try {
                console.log('=== getDistrictInfo called with distId:', distId);

                // 구역 ID에서 시군구 코드 추출 (앞 5자리)
                const ctyCode = distId.substring(0, 5);
                console.log('Extracted ctyCode:', ctyCode);

                // 해당 시군구의 CSV가 캐시에 없으면 로드
                if (!districtCsvCache[ctyCode]) {
                    // feed-a.html은 Web 폴더에 있고, Data 폴더도 Web 안에 있음
                    const csvPath = `Data/District/${ctyCode}_dist_nm_desc.csv`;
                    console.log('Loading district CSV from:', csvPath);

                    const response = await fetch(csvPath);
                    console.log('Fetch response status:', response.status, response.ok);

                    if (!response.ok) {
                        throw new Error(`Failed to load district CSV: ${csvPath} (Status: ${response.status})`);
                    }

                    const csvText = await response.text();
                    console.log('CSV text length:', csvText.length);
                    console.log('CSV first 200 chars:', csvText.substring(0, 200));

                    districtCsvCache[ctyCode] = parseCsv(csvText);
                    console.log('CSV parsed successfully for:', ctyCode, 'rows:', districtCsvCache[ctyCode].length);
                    console.log('First row:', districtCsvCache[ctyCode][0]);
                    console.log('All dist_ids:', districtCsvCache[ctyCode].map(r => r.dist_id).slice(0, 10));
                }

                console.log('Looking for dist_id:', distId, 'in cache');
                const distInfo = districtCsvCache[ctyCode].find(row => {
                    const matches = row.dist_id === distId;
                    if (!matches) {
                        console.log('  Comparing:', row.dist_id, '!=', distId);
                    }
                    return matches;
                });

                if (distInfo) {
                    console.log('*** Found district info:', distInfo);
                } else {
                    console.warn('*** No match found for dist_id:', distId);
                    console.log('Available dist_ids:', districtCsvCache[ctyCode].map(r => r.dist_id));
                }
                return distInfo;
            } catch (error) {
                console.error('!!! Error in getDistrictInfo:', error);
                return null;
            }
        }

        async function loadRecommendDistricts(personaId) {
            try {
                const response = await fetch('Data/L2.A/A_recommend_district.json');
                if (!response.ok) {
                    throw new Error('Failed to load district data');
                }

                const districtData = await response.json();
                const personaDistricts = districtData.filter(entry => entry.persona_id === personaId);
                if (personaDistricts.length === 0) {
                    return;
                }

                const top3Container = document.getElementById('top3DistrictList');
                const secondaryContainer = document.getElementById('secondaryDistrictList');

                if (top3Container) {
                    top3Container.innerHTML = '';
                    for (let i = 0; i < Math.min(3, personaDistricts.length); i++) {
                        const card = await createDistrictCard({
                            label: `TOP ${i + 1}`,
                            distId: personaDistricts[i].dist_id,
                            personaId: personaId
                        });
                        top3Container.appendChild(card);
                    }
                }

                if (secondaryContainer) {
                    secondaryContainer.innerHTML = '';
                    for (let i = 3; i < Math.min(5, personaDistricts.length); i++) {
                        const card = await createDistrictCard({
                            label: '근거리',
                            distId: personaDistricts[i].dist_id,
                            personaId: personaId
                        });
                        secondaryContainer.appendChild(card);
                    }
                }
            } catch (error) {
                console.error('Error loading district data:', error);
            }
        }

        // 페르소나 데이터 로드 및 적용
        async function loadPersonaData() {
            try {
                const personaId = getPersonaIdFromUrl();
                const trsType = getTrsTypeFromUrl();
                const houseType = getHouseTypeFromUrl();

                console.log('Loading persona:', personaId, 'trs_type:', trsType, 'house_type:', houseType);

                // 탭 하이라이트 업데이트
                updateTabHighlight(trsType);

                // house_type 표시
                updateSectionSubtitle(houseType);

                // JSON 파일 로드
                const response = await fetch('Source/Feed_A_Persona_Pref.json');
                if (!response.ok) {
                    throw new Error('Failed to load persona data');
                }

                const personaData = await response.json();

                // 해당 페르소나 찾기
                const selectedPersona = personaData.find(p => p.persona_id === personaId);

                if (selectedPersona) {
                    // headline 업데이트
                    const headlineElement = document.getElementById('personaHeadline');
                    if (headlineElement) {
                        headlineElement.textContent = selectedPersona.headline;
                    }

                    // bullet-list 업데이트
                    const bulletListElement = document.getElementById('personaBulletList');
                    if (bulletListElement && selectedPersona.checks) {
                        bulletListElement.innerHTML = '';
                        selectedPersona.checks.forEach(check => {
                            const li = document.createElement('li');
                            li.textContent = check;
                            bulletListElement.appendChild(li);
                        });
                    }

                    await loadPersonaPreferenceCards(personaId);
                    await loadRecommendDistricts(personaId);

                    console.log('Persona loaded successfully:', selectedPersona.persona_name);
                } else {
                    console.warn('Persona not found:', personaId);
                }
            } catch (error) {
                console.error('Error loading persona data:', error);
                // 에러 발생 시 디폴트 콘텐츠 유지
            }
        }

        // 페이지 로드 시 실행
        window.addEventListener('DOMContentLoaded', loadPersonaData);
    </script>
</body>

</html>